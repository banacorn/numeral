\documentclass[../thesis.tex]{subfiles}
\begin{document}
\chapter{Construction}
%  [draft]

\section{Digit: the basic building block}\label{digit}
% [draft]

Numerals are composed of sequences of \textbf{digits}. We will demonstrate how
to choose a suitable representation for digits in this section.

The same digit may represent different values in different numeral systems, so it
is essential to make the context clear. Here are the generalizations introduced in
section~\ref{introduction} that may effect the evaluation of a digit.

\begin{itemize}
    \item \textbf{\#digit}: the number of digits, denoted {\lstinline|d|}.
    \item \textbf{offset}: the value where a digit starts from, denoted {\lstinline|o|}.
\end{itemize}


\subsection{Fin}

To represent a digit, we use a datatype that is conventionally called \textit{Fin}
which can be indexed to have some exact number of inhabitants.

\begin{lstlisting}
data Fin : ℕ → Set where
    zero : {n : ℕ} → Fin (suc n)
    suc  : {n : ℕ} (i : Fin n) → Fin (suc n)
\end{lstlisting}

The definition of {\lstinline|Fin|} looks the same as {\lstinline|ℕ|} on the term
level, but different on the type level. The index of a {\lstinline|Fin|} increases
with every {\lstinline|suc|}, and there can only be at most {\lstinline|n|} of
them before reaching {\lstinline|Fin (suc n)|}. In other words, {\lstinline|Fin n|}
would have exactly \textit{n} inhabitants.

\textit{Fin} is available in the stardard library, along with other auxiliary
functions:

\begin{itemize}
    \item {\lstinline|toℕ : ∀ {n} → Fin n → ℕ|}
        \\ converts from {\lstinline|Fin n|} to {\lstinline|ℕ|}.
    \item {\lstinline|fromℕ≤ : ∀ {m n} → m < n → Fin n|}
        \\ converts from {\lstinline|ℕ|} to {\lstinline|Fin n|} given the number is small enough.
    \item {\lstinline|#_ : ∀ m {n} {m<n : True (suc m N≤? n)} → Fin n|}
        \\ similar to {\lstinline|fromℕ≤|}, but more convenient, since the proof of {\lstinline|m<n|} is decidable thus can be inferred and made implicit.
    \item {\lstinline|inject≤ : ∀ {m n} → Fin m → m ≤ n → Fin n|}
        \\ converts a smaller {\lstinline|Fin|} to a larger {\lstinline|Fin|}.
\end{itemize}

\subsection{Definition}

{\lstinline|Digit|} is simply just a synonym for {\lstinline|Fin|}, indexed by
the number of digits {\lstinline|d|} of a system.

\begin{lstlisting}
Digit : ℕ → Set
Digit d = Fin d
\end{lstlisting}

Binary digits for example can thus be represented as:

\begin{lstlisting}
Binary : Set
Binary = Digit 2

零 : Binary
零 = zero

一 : Binary
一 = suc zero
\end{lstlisting}

\subsection{Converting from and to natural numbers}

Digit are evaluated together with the offset {\lstinline|o|} of a system.

\begin{lstlisting}
Digit-toℕ : ∀ {d} → Digit d → ℕ → ℕ
Digit-toℕ x o = toℕ x + o
\end{lstlisting}

However, not all natural numbers can be converted to digits.
The value has to be in a certain range, between $ o $ and $ d + o $.
Values less than $ o $ are [synonym of truncated] to $ o $.
Values greater than $ d + o $ are prohibited by {\lstinline|upper-bound : d + o ≥ n|}.

\begin{lstlisting}
Digit-fromℕ : ∀ {d}
    → (n o : ℕ)
    → (upper-bound : d + o ≥ n)
    → Digit (suc d)
Digit-fromℕ = ...
\end{lstlisting}


\paragraph{Properties}
{\lstinline|Digit-fromℕ-toℕ|} states that the value of a natural number should
remain the same, after converted back and forth between {\lstinline|Digit|} and
{\lstinline|ℕ|}.

\begin{lstlisting}
Digit-fromℕ-toℕ : ∀ {d o}
    → (n : ℕ)
    → (lower-bound :     o ≤ n)
    → (upper-bound : d + o ≥ n)
    → Digit-toℕ (Digit-fromℕ {d} n o upper-bound) o ≡ n
Digit-fromℕ-toℕ = ...
\end{lstlisting}

Digits have a upper-bound and a lower-bound after evaluation.

\begin{lstlisting}
Digit-upper-bound : ∀ {d} → (o : ℕ) → (x : Digit d) → Digit-toℕ x o < d + o
Digit-upper-bound {d} o x = +n-mono o (bounded x)

Digit-lower-bound : ∀ {d} → (o : ℕ) → (x : Digit d) → Digit-toℕ x o ≥ o
Digit-lower-bound {d} o x = m≤n+m o (toℕ x)
\end{lstlisting}


\subsection{Constants}

These "constants" are special digits that inhabited in each system.


% There are special digits in each system.

\subsubsection{The greatest digit}

\subsubsection{The carry}







% A system can only have \textbf{finitely many} digits.
% Operations on these digits, such as addition, must be \textbf{constant time}.
% Notice that the problem size of time complexity we are discussing here refers
% only to the value of a numeral. And since the value of digits is independent of
% the value of a numeral, time complexity of functions on digits should be trivially
% constant.




% In section~\ref{introduction} we see that
% different numeral systems a digit


% As introduced in section~\ref{introduction}

% Two generalizations introduced in section~\ref{introduction}
%
% \begin{itemize}
%     \item \textbf{base}: the base of a numeral system, denoted {\lstinline|b|}.
%     \item \textbf{\#digit}: the number of digits, denoted {\lstinline|d|}.
%     \item \textbf{offset}: the number where the digits starts from, denoted {\lstinline|o|}.
% \end{itemize}


\section{Num: a representation for positional numeral systems}\label{representation}
% [draft]

In this section, we will demonstrate how to construct the representation for positional
numeral systems in Agda. The representation is constructed as a datatype, indexed
by the generalizations introduced in section~\ref{introduction}.

\begin{itemize}
    \item \textbf{base}: the base of a numeral system, denoted {\lstinline|b|}.
    \item \textbf{\#digit}: the number of digits, denoted {\lstinline|d|}.
    \item \textbf{offset}: the number where the digits starts from, denoted {\lstinline|o|}.
\end{itemize}



\subsubsection{Properties}

% A digit is bounded to have
%
% \begin{lstlisting}
% Digit-upper-bound : ∀ {d} → (o : ℕ) → (x : Digit d) → Digit-toℕ x o < d + o
% Digit-upper-bound {d} o x = +n-mono o (bounded x)
%
% Digit-lower-bound : ∀ {d} → (o : ℕ) → (x : Digit d) → Digit-toℕ x o ≥ o
% Digit-lower-bound {d} o x = m≤n+m o (toℕ x)
% \end{lstlisting}

\subsection{Num}
% [draft]

Numerals in positional numeral systems are composed of sequences of \textbf{digits}.

\subsubsection{Definition}
The definition of {\lstinline|Numeral|} is similar to that of {\lstinline|List|},
except that a {\lstinline|Numeral|} must contain at least one digit while a list
may contain no elements at all. The most significant digit is placed in {\lstinline|_∙|}
while the least significant digit is placed at the end of the sequence.
{\lstinline|Numeral|} is indexed by all three generalizations.

\begin{lstlisting}
infixr 5 _∷_

data Numeral : ℕ → ℕ → ℕ → Set where
    _∙  : ∀ {b d o} → Digit d → Numeral b d o
    _∷_ : ∀ {b d o} → Digit d → Numeral b d o → Numeral b d o
\end{lstlisting}

The decimal number "2016" for example can be represented as:

\begin{lstlisting}
MMXVI : Numeral 10 10 0
MMXVI = # 6 ∷ # 1 ∷ # 0 ∷ (# 2) ∙
\end{lstlisting}

\subsubsection{Converting to natural numbers}

Converting to natural numbers is fairly trivial:

\begin{lstlisting}
⟦_⟧ : ∀ {b d o} → (xs : Numeral b d o) → ℕ
⟦_⟧ {_} {_} {o} (x ∙)    = Digit-toℕ x o
⟦_⟧ {b} {_} {o} (x ∷ xs) = Digit-toℕ x o + ⟦ xs ⟧ * b
\end{lstlisting}

\section{Dissecting Num: Properties of different kinds of numeral systems}\label{views}

There are many kinds of numeral systems inhabit in {\lstinline|Num|}.
Some have infinitely many numerals and some have none.

We sort the systems in {\lstinline|Num|} into four groups, each of them have
different interesting properties.

\subsection{Views}


\begin{lstlisting}
data NumView : ℕ → ℕ → ℕ → Set where
    NullBase    : ∀   d o                            → NumView 0       (suc d) o
    NoDigits    : ∀ b o                              → NumView b       0       o
    AllZeros    : ∀ b                                → NumView (suc b) 1       0
    Proper      : ∀ b d o → (proper : suc d + o ≥ 2) → NumView (suc b) (suc d) o
\begin{lstlisting}

\subsection{Maximum}

A number is said to be \textit{maximum} if there are no other number greater than
itself.

\begin{lstlisting}
Maximum : ∀ {b d o} → (xs : Numeral b d o) → Set
Maximum {b} {d} {o} xs = ∀ (ys : Numeral b d o) → ⟦ xs ⟧ ≥ ⟦ ys ⟧
\end{lstlisting}


\section{Conclusions}\label{conclusions}

\end{document}
