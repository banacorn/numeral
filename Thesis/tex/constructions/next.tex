\providecommand{\main}{../..}
\documentclass[\main/thesis.tex]{subfiles}
\begin{document}

\section{The Next Numeral}\label{next}

Paul Benacerraf once argued\cite{benacerraf1965numbers} that, there are two kinds
of \textit{counting} which correspond to \textbf{transitive} and \textbf{intransitive}
uses of the verb ``to count.'' Transitive counting, in his sense, is to assign one
of the numbers to the cardinality of a set, by establishing a one-to-one correspondence
between the numbers and the objects one is counting, all the way from none to
all. Intransitive counting, on the other hand, is to generate a sequence of
notation, that could go as far as we need. And it seems that one can only learn
how to count intransitively first, before knowning how to count transitively,
but not vice versa. So it is important to know how to generate the next numeral
we need.

\subsection{What does it mean by ``The Next''?}

When mapping some systems such as {\lstinline|Numeral 10 5 0|} onto
the natural numbers, their number lines appear to be ``gapped'' because their
evaluations are not \textit{surjective}.
The number ``6'', for example, has no correspondence on the numeral side.

\begin{center}
    \begin{adjustbox}{max width=\textwidth}
        \begin{tikzpicture}
            % the frame
            \path[clip] (0, -1) rectangle (50, 1);
            % the spine
            \draw[ultra thick] (0,0) -- (50,0);
            % the body
            \draw[thick] (1, 0.4) rectangle (9, 0.6);
            % \draw[thick, fill=black] (1, -0.1) rectangle (9, +0.1);

            % ticks
            \foreach \i in {1,...,9} {
                \draw[ultra thick, draw=white] (\i,-0.3) -- (\i,0.3);
            };
            %
            % % labels
            % \draw[->, ultra thick] (1.5,1) -- (1.5,0.5)
            %     node at (1.5, 1.3) {\numexpr$o$};
            % \draw[->, ultra thick] (8.5,1) -- (8.5,0.5)
            %     node at (8.5, 1.3) {\numexpr$o+d$};
        \end{tikzpicture}
    \end{adjustbox}
\end{center}

\begin{center}
    \begin{adjustbox}{max width=\textwidth}
        \begin{tikzpicture}
            % a straight line segment
            \draw (0, 0) -- (10, 0);
            % the ticks and their labels
            \foreach \x  in {0,...,5}
                \draw[xshift=\x*2 cm] (0pt,2pt) -- (0pt,-1pt) node[below,fill=white] {\scriptsize\the\numexpr\x*10\relax};
            \foreach \x  in {0,...,4}
                \draw[ultra thick, xshift=\x*2 cm, yshift=\x*0.3 cm] (0,0.3) -- (1,0.3);
            % labels
            \node at (5, -1) {{\lstinline|Numeral 10 5 0|}};
        \end{tikzpicture}
    \end{adjustbox}
\end{center}

Whilst systems such as {\lstinline|Numeral 10 15 0|} map more than one numeral
onto the same number. We can see immediately that their evaluations are not
\textit{injective} as those number lines ``overlap'' with each other.

\begin{center}
    \begin{adjustbox}{max width=\textwidth}
        \begin{tikzpicture}
            % a straight line segment
            \draw (0, 0) -- (10, 0);
            % the ticks and their labels
            \foreach \x  in {0,...,5}
                \draw[xshift=\x*2 cm] (0pt,2pt) -- (0pt,-1pt) node[below,fill=white] {\scriptsize\the\numexpr\x*10\relax};
            \foreach \x  in {0,...,3}
                \draw[ultra thick, xshift=\x*2 cm, yshift=\x*0.3 cm] (0,0.3) -- (3,0.3);
            \draw[ultra thick, xshift=8 cm, yshift=1.2 cm] (0,0.3) -- (2,0.3);
            % labels
            \node at (5, -1) {{\lstinline|Numeral 10 15 0|}};
        \end{tikzpicture}
    \end{adjustbox}
\end{center}

As we can see, numerals do not align with numbers perfectly.
Finding ``the next number'' thus becomes a non-trivial problem.
Therefore, we define the next numeral as \textbf{the least numeral that is greater than itself}.

\subsection{Implementation}

Given a numeral, say {\lstinline|xs|}, to find the next numeral of {\lstinline|xs|},
it reasonable to expect that {\lstinline|xs|} must not be a maximum.
Otherwise, there would exist no such a numeral that is \textit{greater than itself}.

Again, the indices are classified by {\lstinline|numView|} into four categories.
The case of {\lstinline|NoDigits|} and {\lstinline|AllZeros|} are rather trivial.
We focus on the other two.

\begin{lstlisting}
next-number : ∀ {b d o}
    → (xs : Numeral b d o)
    → ¬ (Maximum xs)
    → Numeral b d o
next-number {b} {d} {o} xs ¬max with numView b d o
next-number xs ¬max | NullBase d o = ?
next-number xs ¬max | NoDigits b o = NoDigits-explode xs
next-number xs ¬max | AllZeros b   =
    contradiction (Maximum-AllZeros xs) ¬max
next-number xs ¬max | Proper b d o proper = ?
\end{lstlisting}

\subsection{Validating the Implementation}

To validate the correctness of the implementation of {\lstinline|next-number|},
i.e., to make sure that the function does return a numeral that is:

\begin{enumerate}
    \item greater than the given numeral
    \item the least of all such numerals
\end{enumerate}

We need to prove these two propositions:

\begin{lstlisting}
next-number-is-greater : ∀ {b d o}
    → (xs : Numeral b d o)
    → (¬max : ¬ (Maximum xs))
    → ⟦ next-number xs ¬max ⟧ > ⟦ xs ⟧
\end{lstlisting}

\begin{lstlisting}
next-number-is-immediate : ∀ {b d o}
    → (xs : Numeral b d o)
    → (ys : Numeral b d o)
    → (¬max : ¬ (Maximum xs))
    → ⟦ ys ⟧ > ⟦ xs ⟧
    → ⟦ ys ⟧ ≥ ⟦ next-number xs ¬max ⟧
\end{lstlisting}

We come up with the name ``immediate''
because ``the least numeral that is greater than itself'' is a bit too wordy.

\subsection{Outline}

We are going to finish programs and proofs of systems of {\lstinline|NullBase|}
and {\lstinline|Proper|} respectively.

\begin{itemize}
    \item {\lstinline|NullBase|}
        \begin{enumerate}
            \item {\lstinline|next-number-NullBase|}
            \item {\lstinline|next-number-is-greater-NullBase|}
            \item {\lstinline|next-number-is-immediate-NullBase|}
        \end{enumerate}
    \item {\lstinline|Proper|}
        \begin{itemize}
            \item {\lstinline|next-number-Proper|}
            \item {\lstinline|next-number-is-greater-Proper|}
            \item {\lstinline|next-number-is-immediate-Proper|}
        \end{itemize}
\end{itemize}

However, programs and proofs of systems of {\lstinline|Proper|} will be defined
\textit{simultaneously} with mutually recursive definitions.
The reason why we need properties like {\lstinline|next-number-is-greater-Proper|}
and {\lstinline|next-number-is-immediate-Proper|} in the first place is that
they are neccessary for implementing {\lstinline|next-number-Proper|}.

\subsection{The Next Numeral of NullBase}

To find the next numeral of systems of {\lstinline|NullBase|},
all we have to do is to manipulate the LSD.
Since only the value of the LSD has effect on the evaluation.
All numerals are mapped onto this single and continuous number line below.

\begin{center}
    \begin{adjustbox}{max width=\textwidth}
        \begin{tikzpicture}
            % the frame
            \path[clip] (0, -1) rectangle (10, 2);
            % the spine
            \draw[ultra thick] (0,0) -- (10,0);
            % the body
            \draw[thick] (1, -0.2) rectangle (9, +0.2);
            \draw[thick, fill=black] (1, -0.2) rectangle (9, +0.2);

            % ticks
            \foreach \i in {1,...,9} {
                \draw[ultra thick, draw=white] (\i,-0.3) -- (\i,0.3);
            };

            % labels
            \draw[->, ultra thick] (1.5,1) -- (1.5,0.5)
                node at (1.5, 1.3) {\numexpr$o$};
            \draw[->, ultra thick] (8.5,1) -- (8.5,0.5)
                node at (8.5, 1.3) {\numexpr$o+d$};
        \end{tikzpicture}
    \end{adjustbox}
\end{center}

Finding the next numeral is as simple as incrementing the LSD.
To make room for the increment, numerals that are mapped onto the rightmost
number of the line have to be excluded.

\begin{center}
    \begin{adjustbox}{max width=\textwidth}
        \begin{tikzpicture}
            % the frame
            \path[clip] (0, -1) rectangle (10, 2);
            % the spine
            \draw[ultra thick] (0,0) -- (10,0);
            % the body
            \draw[thick] (1, -0.2) rectangle (9, +0.2);
            \draw[thick, fill=black] (1, -0.2) rectangle (8, +0.2);
            \draw[thick, fill=gray, draw=gray] (8, -0.2) rectangle (9, +0.2);

            % ticks
            \foreach \i in {1,...,9} {
                \draw[ultra thick, draw=white] (\i,-0.3) -- (\i,0.3);
            };

            % labels
            \draw[->, ultra thick] (1.5,1) -- (1.5,0.5)
                node at (1.5, 1.3) {\numexpr$o$};
            \draw[->, ultra thick] (7.5,1) -- (7.5,0.5)
                node at (7.5, 1.3) {\numexpr$o+d-1$};

            % arrows
            \foreach \i in {0,...,9} {
                \coordinate (\i) at ({\i + 0.5}, -0.3);
            };
            \foreach \i in {1,...,7} {
                \pgfmathsetmacro{\j}{\i + 1}
                \path[->, ultra thick] (\i) edge[bend right=60] node {} ($ (\j) + (-0.1, 0) $);
            };
        \end{tikzpicture}
    \end{adjustbox}
\end{center}

\subsubsection{{\lstinline|next-number-NullBase|}}

Numerals with the greatest LSD are first ruled out because they also happen
to be maxima. The rest of the numerals are then pattern matched to have their
LSDs replaced with an incremented one.

\begin{lstlisting}
next-number-NullBase : ∀ {d o}
    → (xs : Numeral 0 (suc d) o)
    → ¬ (Maximum xs)
    → Numeral 0 (suc d) o
next-number-NullBase xs       ¬max with Greatest? (lsd xs)
next-number-NullBase xs       ¬max | yes greatest =
    contradiction (Maximum-NullBase-Greatest xs greatest) ¬max
next-number-NullBase (x ∙)    ¬max | no ¬greatest =
    digit+1 x ¬greatest ∙
next-number-NullBase (x ∷ xs) ¬max | no ¬greatest =
    digit+1 x ¬greatest ∷ xs
\end{lstlisting}

\subsubsection{Lemma}

Instead of proving that {\lstinline|next-number-NullBase|} does compute a numeral
that is:
\begin{enumerate}
    \item greater than the given numeral
    \item the least of all such numerals
\end{enumerate}

We prove a stronger proposition, that {\lstinline|next-number-NullBase|} would
compute the \textit{successor} of the given number.

\begin{lstlisting}[basicstyle=\ttfamily\scriptsize]
next-number-NullBase-lemma : ∀ {d o}
    → (xs : Numeral 0 (suc d) o)
    → (¬max : ¬ (Maximum xs))
    → ⟦ next-number-NullBase xs ¬max ⟧ ≡ suc ⟦ xs ⟧
next-number-NullBase-lemma {d} {o} xs    ¬max with Greatest? (lsd xs)
next-number-NullBase-lemma {d} {o} xs    ¬max | yes greatest =
    contradiction (Maximum-NullBase-Greatest xs greatest) ¬max
next-number-NullBase-lemma {d} {o} (x ∙) ¬max | no ¬greatest =
    begin
        ⟦ digit+1 x ¬greatest ∙ ⟧
    ≡⟨ refl ⟩
        Digit-toℕ (digit+1 x ¬greatest) o
    ≡⟨ digit+1-toℕ x ¬greatest ⟩
        suc (Fin.toℕ x + o)
    ≡⟨ refl ⟩
        suc ⟦ x ∙ ⟧
    ∎
next-number-NullBase-lemma {d} {o} (x ∷ xs) ¬max | no ¬greatest =
    begin
        ⟦ digit+1 x ¬greatest ∷ xs ⟧
    ≡⟨ refl ⟩
        Digit-toℕ (digit+1 x ¬greatest) o + ⟦ xs ⟧ * zero
    ≡⟨ cong (λ w → w + ⟦ xs ⟧ * zero) (digit+1-toℕ x ¬greatest) ⟩
        suc (Fin.toℕ x + o + ⟦ xs ⟧ * zero)
    ≡⟨ refl ⟩
        suc ⟦ x ∷ xs ⟧
    ∎
\end{lstlisting}

\subsubsection{{\lstinline|next-number-is-greater-NullBase|}}

Recall that {\lstinline|x < y|} is essentially a synonym of {\lstinline|suc x ≤ y|}.
We nail this with the lemma we have just proven.

\begin{lstlisting}
next-number-is-greater-NullBase : ∀ {d o}
    → (xs : Numeral 0 (suc d) o)
    → (¬max : ¬ (Maximum xs))
    → ⟦ next-number-NullBase xs ¬max ⟧ > ⟦ xs ⟧
next-number-is-greater-NullBase xs ¬max =
    start
        suc ⟦ xs ⟧
    ≈⟨ sym (next-number-NullBase-lemma xs ¬max) ⟩
        ⟦ next-number-NullBase xs ¬max ⟧
    □
\end{lstlisting}

\subsubsection{{\lstinline|next-number-is-immediate-NullBase|}}

Here, the argument {\lstinline|ys|} stands for \textit{any} numeral of {\lstinline|Numeral 0 (suc d) o|}.

\begin{lstlisting}
next-number-is-immediate-NullBase : ∀ {d o}
    → (xs : Numeral 0 (suc d) o)
    → (ys : Numeral 0 (suc d) o)
    → (¬max : ¬ (Maximum xs))
    → ⟦ ys ⟧ > ⟦ xs ⟧
    → ⟦ ys ⟧ ≥ ⟦ next-number-NullBase xs ¬max ⟧
next-number-is-immediate-NullBase xs ys ¬max prop =
    start
        ⟦ next-number-NullBase xs ¬max ⟧
    ≈⟨ next-number-NullBase-lemma xs ¬max ⟩
        suc ⟦ xs ⟧
    ≤⟨ prop ⟩
        ⟦ ys ⟧
    □
\end{lstlisting}

\subsection{The Next Numeral of Proper}

Unlike in systems of {\lstinline|NullBase|} where every numeral gets mapped onto
a single and continuous number line.
Things are way more complicated in systems of {\lstinline|Proper|}.

% \subsubsection{Interior Numerals}

\begin{center}
    \begin{adjustbox}{max width=\textwidth}
        \begin{tikzpicture}
            \path[clip] (5.5, -0.5) rectangle (17.5, 2.5);

            \foreach \i in {0,...,2} {
                \draw[xshift=\i*8 cm, yshift=\i*0.6 cm, ultra thick] (0, 0.4) rectangle (7, 0.8);
                \draw[xshift=\i*8 cm, yshift=\i*0.6 cm, ultra thick, fill=black] (0, 0.4) rectangle (6, 0.8);
                \draw[xshift=\i*8 cm, yshift=\i*0.6 cm, ultra thick, fill=gray] (6, 0.4) rectangle (7, 0.8);
            };

            \foreach \i in {5,...,6} {
                \coordinate (\i) at ({\i + 0.5}, 0.3);
            };
            \foreach \i in {8,...,15} {
                \coordinate (\i) at ({\i + 0.5}, 0.9);
            };
            \foreach \i in {16,...,17} {
                \coordinate (\i) at ({\i + 0.5}, 1.5);
            };

            \foreach \i in {5,...,5} {
                \pgfmathsetmacro{\j}{\i + 1}
                \path[->, ultra thick] ($ (\i) + (+0.1, 0) $) edge[bend right=60] node {} ($ (\j) + (-0.1, 0) $);
            };
            \foreach \i in {8,...,13} {
                \pgfmathsetmacro{\j}{\i + 1}
                \path[->, ultra thick] ($ (\i) + (+0.1, 0) $) edge[bend right=60] node {} ($ (\j) + (-0.1, 0) $);
            };
            \foreach \i in {16,...,16} {
                \pgfmathsetmacro{\j}{\i + 1}
                \path[->, ultra thick] ($ (\i) + (+0.1, 0) $) edge[bend right=60] node {} ($ (\j) + (-0.1, 0) $);
            };

        \end{tikzpicture}
    \end{adjustbox}
\end{center}

\begin{center}
    \begin{adjustbox}{max width=\textwidth}
        \begin{tikzpicture}
            \path[clip] (5.5, -0.5) rectangle (17.5, 2.5);

            \foreach \i in {0,...,2} {
                \draw[xshift=\i*8 cm, yshift=\i*0.6 cm, ultra thick] (0, 0.4) rectangle (7, 0.8);
                \draw[xshift=\i*8 cm, yshift=\i*0.6 cm, ultra thick, fill=black] (6, 0.4) rectangle (7, 0.8);
                \draw[xshift=\i*8 cm, yshift=\i*0.6 cm, ultra thick, fill=gray] (8, 1) rectangle (9, 1.4);
            };

            \coordinate (A) at (7.1, 0.6);
            \coordinate (11) at (8.5, 0.9);
            \coordinate (1A) at (15.1, 1.2);
            \coordinate (21) at (16.5, 1.5);

            \path[->, ultra thick] (A) edge[bend right=60] node {} (11);
            \path[->, ultra thick] (1A) edge[bend right=60] node {} (21);

        \end{tikzpicture}
    \end{adjustbox}
\end{center}

\begin{center}
    \begin{adjustbox}{max width=\textwidth}
        \begin{tikzpicture}
            \path[clip] (6.5, -0.5) rectangle (18.5, 2.5);

            \foreach \i in {0,...,2} {
                \draw[xshift=\i*8 cm, yshift=\i*0.6 cm, ultra thick] (0, 0.4) rectangle (9, 0.8);
                \draw[xshift=\i*8 cm, yshift=\i*0.6 cm, ultra thick, fill=black] (8, 0.4) rectangle (9, 0.8);
                \draw[xshift=\i*8 cm, yshift=\i*0.6 cm, ultra thick, fill=gray] (9, 1) rectangle (10, 1.4);
            };

            \coordinate (A) at (9.1, 0.6);
            \coordinate (11) at (9.5, 0.9);
            \coordinate (1A) at (17.1, 1.2);
            \coordinate (21) at (17.5, 1.5);

            \path[->, ultra thick] (A) edge[bend right] node {} (11);
            \path[->, ultra thick] (1A) edge[bend right] node {} (21);

        \end{tikzpicture}
    \end{adjustbox}
\end{center}


% There are three cases in {\lstinline|Proper|} we need to ha.

% Revisit the view function {\lstinline|numView|}.
% First, it pattern matches on {\lstinline|d|}, excluding systems with no digits;
% and then on {\lstinline|b|}, exluding systems with bases of $ 0 $.
% There is an order of pattern matching on the three indices.
%
\end{document}
